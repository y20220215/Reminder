<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ë§ˆì¸ë” ìœ„ì ¯ (íŒ¨ì¹˜)</title>
    <style>
        /* (ì›ë³¸ CSSë¥¼ ëŒ€ë¶€ë¶„ ìœ ì§€) */
        /* NOTE: CSSëŠ” ì›ë³¸ì„ ìœ ì§€í•˜ê³  JSì—ì„œ ë™ì ìœ¼ë¡œ í…Œë§ˆë¥¼ ì²˜ë¦¬í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. */
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:transparent;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;margin:0}
        .widget-container{width:100%;max-width:400px;min-width:220px;background:#fdfbfb;border-radius:4px;padding:16px;border:1px solid rgba(0,0,0,0.08);box-sizing:border-box}
        .widget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(0,0,0,0.06)}
        .widget-title{font-size:15px;font-weight:700;color:#3a3a3a;letter-spacing:-0.3px}
        .header-right{display:flex;align-items:center;gap:6px}
        .add-btn{width:24px;height:24px;background:transparent;border:none;border-radius:8px;color:#a888c9;font-size:16px;font-weight:400;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .add-btn:hover{transform:scale(1.1)}
        .add-btn:active{transform:scale(.95)}
        .color-picker-btn{width:22px;height:22px;border-radius:50%;border:3px solid rgba(255,255,255,.9);cursor:pointer;transition:transform .2s;position:relative}
        .color-picker-btn::before{content:'';position:absolute;inset:-3px;border-radius:50%;background:inherit;z-index:-1}
        .color-picker-btn:hover{transform:scale(1.1)}
        .filter-bar{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
        .filter-btn{padding:4px 8px;font-size:11px;border:none;border-radius:3px;cursor:pointer;transition:all .2s;font-weight:500}
        .filter-btn.active{color:white}
        .reminder-list{max-height:450px;overflow-y:auto;padding-right:4px}
        .reminder-list::-webkit-scrollbar{width:4px;height:4px}
        .reminder-list::-webkit-scrollbar-track{background:rgba(0,0,0,.03);border-radius:2px}
        .empty-state{text-align:center;padding:40px 20px;color:#999}
        .empty-state-icon{font-size:32px;margin-bottom:10px;opacity:.5}
        .empty-state-text{font-size:13px;line-height:1.6}
        .reminder-item{padding:6px 6px;margin-bottom:2px;display:flex;align-items:center;gap:8px;cursor:move;transition:all .2s ease;border-radius:2px;position:relative}
        .reminder-item.dragging{opacity:.5;background:rgba(0,0,0,.05)}
        .reminder-item.drag-over{border-top:2px solid #c9a9e9}
        .reminder-item.has-children{margin-bottom:0}
        .reminder-item.urgent-alert{background:rgba(255,107,157,.1);border-left:3px solid #ff6b9d;padding-left:3px}
        .toggle-btn{width:14px;height:14px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .2s}
        .toggle-btn.collapsed{transform:rotate(-90deg)}
        .star-btn{width:16px;height:16px;cursor:pointer;transition:all .2s;flex-shrink:0;position:relative}
        .star-btn svg{width:100%;height:100%;display:block}
        .star-btn:hover{transform:scale(1.2)}
        .star-btn:active{transform:scale(1)}
        .reminder-content{flex:1;min-width:0}
        .reminder-text{font-size:12.5px;color:#2a2a2a;word-break:break-word;line-height:1.4;font-weight:500}
        .reminder-dday{font-size:10.5px;font-weight:600;white-space:nowrap;flex-shrink:0;padding:2px 6px;border-radius:2px}
        .reminder-dday.future{color:#999;background:rgba(0,0,0,.04)}
        .reminder-dday.today{color:#fff;background:linear-gradient(135deg,#ff6b9d 0%,#ff8fb3 100%)}
        .reminder-dday.past{color:#fff;background:linear-gradient(135deg,#a888c9 0%,#b8a5d8 100%)}
        .delete-btn{font-size:18px;color:#ddd;cursor:pointer;transition:all .2s;flex-shrink:0;font-weight:300}
        .delete-btn:hover{color:#ff6b9d;transform:scale(1.1)}
        .delete-btn:active{transform:scale(1)}
        .child-items{margin-left:38px;padding-left:12px;border-left:2px solid rgba(0,0,0,.1);margin-bottom:4px;overflow:hidden;max-height:0;transition:max-height .3s ease}
        .child-items.expanded{max-height:1000px}
        .child-item{padding:5px 6px;margin-bottom:2px;display:flex;align-items:center;gap:6px;font-size:11.5px;color:#666;line-height:1.4}
        .child-item.completed{opacity:.5}
        .child-item.completed .child-text{text-decoration:line-through}
        .child-checkbox{width:14px;height:14px;cursor:pointer;flex-shrink:0}
        .child-text{flex:1}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);justify-content:center;align-items:center;z-index:1000}
        .modal.active{display:flex}
        .modal-content{background:white;border-radius:6px;padding:20px;width:90%;max-width:320px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.25);transition:border-color .2s}
        .modal-content.themed{border:2px solid}
        .modal-title{font-size:15px;font-weight:700;color:#3a3a3a;margin-bottom:16px;letter-spacing:-0.3px}
        .input-group{margin-bottom:14px}
        .input-label{display:block;font-size:12px;color:#555;margin-bottom:5px;font-weight:600}
        .text-input{width:100%;padding:8px 10px;border:1.5px solid #e8e8e8;border-radius:3px;font-size:13px;transition:all .2s;font-family:inherit}
        .text-input:focus{outline:none;border-color:#c9a9e9;box-shadow:0 0 0 3px rgba(201,169,233,.1)}
        .date-input{width:100%;padding:8px 10px;border:1.5px solid #e8e8e8;border-radius:3px;font-size:13px;font-family:inherit;transition:all .2s}
        .date-input:focus{outline:none;border-color:#c9a9e9;box-shadow:0 0 0 3px rgba(201,169,233,.1)}
        .checkbox-group{display:flex;align-items:center;gap:7px;margin-bottom:14px}
        .checkbox-group input[type="checkbox"]{width:15px;height:15px;cursor:pointer}
        .checkbox-group label{font-size:12px;color:#555;cursor:pointer;font-weight:500}
        .child-list{margin-top:12px;padding:12px;background:#f9f9f9;border-radius:4px;max-height:200px;overflow-y:auto}
        .child-input-group{display:flex;gap:6px;margin-bottom:6px;align-items:center}
        .modal-buttons{display:flex;gap:8px;margin-top:16px}
        .btn{flex:1;padding:9px;border:none;border-radius:3px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
        .btn-primary{color:white;transition:all .2s}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(185,165,216,.3)}
        .btn-secondary{background:#f5f5f5;color:#666}
        .color-palette{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:14px}
        .color-option{width:100%;aspect-ratio:1;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .2s}
        .small-btn{padding:5px 10px;font-size:11px;color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600;transition:all .2s}
        .add-child-btn{width:26px;height:26px;padding:0;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;background:transparent;transition:all .2s}
        @media (max-width:350px){.widget-container{padding:10px;min-width:200px}.widget-title{font-size:13px}.add-btn,.color-picker-btn{width:20px;height:20px}.add-btn{font-size:14px}.filter-btn{font-size:10px;padding:3px 5px}.reminder-text{font-size:11.5px}.reminder-dday{font-size:9.5px}.reminder-list{max-height:350px}}
        @media (min-width:400px){.reminder-list{max-height:500px}}
    </style>
</head>
<body>
    <div class="widget-container" id="widget">
        <div class="widget-header">
            <div class="widget-title">My Reminders</div>
            <div class="header-right">
                <button class="add-btn" id="addBtn">+</button>
                <div class="color-picker-btn" id="colorBtn" style="background:#fdfbfb"></div>
            </div>
        </div>
        <div class="filter-bar">
            <button class="filter-btn active" data-filter="all">ì „ì²´</button>
            <button class="filter-btn" data-filter="important">ì¤‘ìš”</button>
            <button class="filter-btn" data-filter="project">í”„ë¡œì íŠ¸</button>
        </div>
        <div class="reminder-list" id="reminderList"></div>
    </div>

    <div class="modal" id="reminderModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">ë¦¬ë§ˆì¸ë” ì¶”ê°€</div>
            <div class="input-group">
                <label class="input-label">í•  ì¼</label>
                <input type="text" class="text-input" id="reminderText" placeholder="ë¬´ì—‡ì„ í•´ì•¼ í•˜ë‚˜ìš”?">
            </div>
            <div class="input-group">
                <label class="input-label">ë§ˆê°ì¼</label>
                <input type="date" class="date-input" id="reminderDate">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="isImportant">
                <label for="isImportant">ì¤‘ìš” í‘œì‹œ</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="hasChildren">
                <label for="hasChildren">í”„ë¡œì íŠ¸ (í•˜ìœ„ í•­ëª© ì¶”ê°€)</label>
            </div>
            <div class="child-list" id="childList" style="display:none">
                <div class="child-input-group">
                    <input type="text" class="text-input" id="childInput" placeholder="í•˜ìœ„ í•­ëª© ì…ë ¥">
                    <button class="small-btn add-child-btn" id="addChildBtn">+</button>
                </div>
                <div id="childItems"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="saveBtn">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="modal" id="colorModal">
        <div class="modal-content">
            <div class="modal-title">ìœ„ì ¯ ìƒ‰ìƒ ì„ íƒ</div>
            <div class="color-palette" id="colorPalette"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="closeColorBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
    (function(){
        'use strict';

        // ì•ˆì „í•œ UUID ìƒì„± (ì§€ì› ì•ˆë˜ë©´ fallback)
        function generateId(){
            if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
            return 'id-' + Date.now().toString(36) + '-' + Math.floor(Math.random()*1e9).toString(36);
        }

        // ë°ì´í„°ì™€ ìƒíƒœ
        let reminders = [];
        let editingId = null;
        // tempChildrenì€ { text: string, completed: boolean } ê°ì²´ ë°°ì—´ë¡œ ë³€ê²½ë¨ (ìˆ˜ì •ë¨)
        let tempChildren = [];
        let currentFilter = 'all';
        let draggedItem = null;

        const colors = [
            { name: 'ë¼ë²¤ë”', bg: '#fdfbfb', accent: '#f5f0f8', border: '#d4b8e6', icon: '#a888c9', line: '#d4b8e6', display: '#e8daf5' },
            { name: 'ë¡œì¦ˆ', bg: '#fff5f8', accent: '#ffe8f0', border: '#ffc2d9', icon: '#ff8fb3', line: '#ffc2d9', display: '#ffc2d9' },
            { name: 'ë¯¼íŠ¸', bg: '#f0fff4', accent: '#e0f9e8', border: '#b3e6c7', icon: '#6bc98e', line: '#b3e6c7', display: '#b3e6c7' },
            { name: 'í”¼ì¹˜', bg: '#fff7ed', accent: '#ffe9d5', border: '#ffc899', icon: '#ff9d52', line: '#ffc899', display: '#ffc899' },
            { name: 'ìŠ¤ì¹´ì´', bg: '#f0f9ff', accent: '#dbeef9', border: '#a8d8f0', icon: '#5eb3d6', line: '#a8d8f0', display: '#a8d8f0' },
            { name: 'ë¦´ë½', bg: '#faf5ff', accent: '#f0e5ff', border: '#d4b8f0', icon: '#a788d1', line: '#d4b8f0', display: '#d4b8f0' },
            { name: 'ì½”ë„', bg: '#fff1f2', accent: '#ffe0e3', border: '#ffb3bb', icon: '#ff7785', line: '#ffb3bb', display: '#ffb3bb' },
            { name: 'ë ˆëª¬', bg: '#fefce8', accent: '#fef9c3', border: '#f5e87a', icon: '#e0c83d', line: '#f5e87a', display: '#f5e87a' },
            { name: 'ì•„ì¿ ì•„', bg: '#ecfeff', accent: '#cff5f7', border: '#8ed9e0', icon: '#3fb3c2', line: '#8ed9e0', display: '#8ed9e0' },
            { name: 'ë¸”ëŸ¬ì‰¬', bg: '#fdf2f8', accent: '#fce4f0', border: '#f5b8d9', icon: '#e880b3', line: '#f5b8d9', display: '#f5b8d9' }
        ];

        let currentTheme = colors[0];

        // ìœ í‹¸: ì•ˆì „í•˜ê²Œ ìš”ì†Œ ì„ íƒ
        function $id(id){const el=document.getElementById(id);if(!el)console.error('ìš”ì†Œ ì—†ìŒ:',id);return el}

        // í•˜ìœ„ í•­ëª© ì •ê·œí™” (Completed ìƒíƒœ ìœ ì§€)
        function normalizeChild(child){
            if (typeof child === 'string') return { text: child, completed: false };
            if (child && typeof child === 'object' && 'text' in child) return { text: child.text || '', completed: !!child.completed };
            return { text: '', completed: false };
        }

        function normalizeReminder(reminder){
            if (!reminder || typeof reminder !== 'object') return null;
            return {
                id: reminder.id || generateId(),
                text: reminder.text || '',
                date: reminder.date || '',
                important: !!reminder.important,
                children: Array.isArray(reminder.children) ? reminder.children.map(normalizeChild) : [],
                collapsed: !!reminder.collapsed
            };
        }

        // ì €ì¥/ë¡œë“œ
        function loadFromStorage(){
            try{
                const saved = localStorage.getItem('reminders');
                const savedTheme = localStorage.getItem('currentTheme');
                if (saved){
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed)) reminders = parsed.map(normalizeReminder).filter(r=>r!==null);
                }
                if (savedTheme){
                    const idx = parseInt(savedTheme);
                    if (!isNaN(idx) && idx>=0 && idx<colors.length) currentTheme = colors[idx];
                }
            }catch(e){
                console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ ì‹¤íŒ¨:',e);
                reminders = [];
                currentTheme = colors[0];
            }
        }

        function saveToStorage(){
            try{
                localStorage.setItem('reminders', JSON.stringify(reminders));
            }catch(e){
                console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:',e);
                try{ localStorage.removeItem('reminders'); }catch(_){}
                alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ìƒì„± (ë¡œì§ ìœ ì§€)
        const colorPalette = $id('colorPalette');
        if (colorPalette){
            colors.forEach((color,index)=>{
                const option = document.createElement('div');
                option.className='color-option';
                option.style.background = color.display;
                if (index === colors.indexOf(currentTheme)) option.classList.add('selected');
                option.addEventListener('click', ()=> selectColor(color, option, index));
                colorPalette.appendChild(option);
            });
        }

        // í…Œë§ˆ ì ìš© (ë¡œì§ ìœ ì§€, CSS ë³€ìˆ˜ ì—†ëŠ” ìƒíƒœì— ë§ì¶° ìµœì†Œí•œìœ¼ë¡œ ìŠ¤íƒ€ì¼ë§)
        function applyTheme(theme){
            const widget = $id('widget');
            const colorBtn = $id('colorBtn');
            const addBtn = $id('addBtn');
            
            // í•„ìˆ˜ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            if (widget) widget.style.background = theme.bg;
            if (colorBtn) colorBtn.style.background = theme.display; // display ìƒ‰ìƒ ì‚¬ìš©
            if (addBtn) addBtn.style.color = theme.icon;

            // í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.filter-btn').forEach(btn=>{
                if (btn.classList.contains('active')){ btn.style.background = theme.icon; btn.style.color = 'white'; }
                else { btn.style.background = theme.accent; btn.style.color = theme.icon; }
            });

            // ëª¨ë‹¬, ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.modal-content').forEach(modal=>{ modal.classList.add('themed'); modal.style.borderColor = theme.border; });
            document.querySelectorAll('.btn-primary').forEach(btn=>{ btn.style.background = theme.icon; });
            document.querySelectorAll('.add-child-btn').forEach(btn=>{ btn.style.color = theme.icon; });
            
            // ë™ì  ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (í¬ì»¤ìŠ¤, ìŠ¤í¬ë¡¤ë°” ë“±)
            const existing = document.getElementById('dynamic-theme-style');
            // D-Day Past/Today ìƒ‰ìƒë„ ì—¬ê¸°ì„œ ë®ì–´ì“°ê¸°
            const css = `
                .text-input:focus, .date-input:focus { border-color: ${theme.icon} !important; box-shadow: 0 0 0 3px ${theme.accent} !important; }
                .reminder-list::-webkit-scrollbar-thumb { background: ${theme.border} !important; border-radius: 2px; }
                .reminder-list::-webkit-scrollbar-thumb:hover { background: ${theme.icon} !important; }
                .modal-content::-webkit-scrollbar-thumb { background: ${theme.border} !important; }
                .modal-content::-webkit-scrollbar-thumb:hover { background: ${theme.icon} !important; }
                .child-list::-webkit-scrollbar-thumb { background: ${theme.border} !important; }
                .child-list::-webkit-scrollbar-thumb:hover { background: ${theme.icon} !important; }
                .reminder-item.drag-over { border-top: 2px solid ${theme.border} !important; }
                .child-items { border-left: 2px solid ${theme.line} !important; }
                .toggle-btn { color: ${theme.icon} !important; }
                .toggle-btn:hover { color: ${theme.border} !important; }
                .reminder-dday.past { background: linear-gradient(135deg, ${theme.icon} 0%, ${theme.border} 100%) !important; }
                .reminder-dday.today { background: linear-gradient(135deg, ${colors[1].icon} 0%, ${colors[1].border} 100%) !important; } /* ë¡œì¦ˆ í…Œë§ˆì˜ D-Dayë¥¼ ìœ ì§€ */
            `;
            if (existing) existing.textContent = css;
            else{
                const style = document.createElement('style');
                style.id = 'dynamic-theme-style';
                style.textContent = css;
                document.head.appendChild(style);
            }
            
            // D-Day Today/Past ìƒ‰ìƒì„ ë°˜ì˜í•˜ê¸° ìœ„í•´ ë Œë”ë§ì„ ë‹¤ì‹œ í˜¸ì¶œ
            renderReminders();
        }

        function selectColor(theme, element, index){
            document.querySelectorAll('.color-option').forEach(el=>el.classList.remove('selected'));
            element.classList.add('selected');
            currentTheme = theme;
            applyTheme(theme);
            try{ localStorage.setItem('currentTheme', index.toString()); }catch(e){ console.error('í…Œë§ˆ ì €ì¥ ì˜¤ë¥˜:',e); }
        }

        // XSS ë°©ì§€: í…ìŠ¤íŠ¸ ë…¸ë“œ ìƒì„± í—¬í¼
        function createTextDiv(className, text){
            const div = document.createElement('div');
            if (className) div.className = className;
            div.appendChild(document.createTextNode(text || ''));
            return div;
        }

        function calculateDday(dateString){
            if (!dateString) return null;
            try{
                const today = new Date(); today.setHours(0,0,0,0);
                const targetDate = new Date(dateString); targetDate.setHours(0,0,0,0);
                if (isNaN(targetDate.getTime())) return null;
                const diff = Math.ceil((targetDate - today) / (1000*60*60*24));
                if (diff === 0) return { text: 'D-Day', type: 'today', diff };
                if (diff < 0) return { text: `D+${Math.abs(diff)}`, type: 'past', diff };
                return { text: `D-${diff}`, type: 'future', diff };
            }catch(e){ console.error('ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜:',e); return null; }
        }

        function filterReminders(list){
            return list.filter(reminder=>{
                if (!reminder) return false;
                switch(currentFilter){
                    case 'important': return !!reminder.important;
                    case 'project': return Array.isArray(reminder.children) && reminder.children.length>0;
                    default: return true;
                }
            });
        }

        function renderEmptyState(){
            const list = $id('reminderList'); if (!list) return;
            list.innerHTML = '';
            const empty = document.createElement('div'); empty.className='empty-state';
            const icon = document.createElement('div'); icon.className='empty-state-icon'; icon.textContent='ğŸ“';
            const txt = document.createElement('div'); txt.className='empty-state-text'; txt.innerHTML = 'ì•„ì§ ë¦¬ë§ˆì¸ë”ê°€ ì—†ì–´ìš”<br>+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•´ë³´ì„¸ìš”!';
            empty.appendChild(icon); empty.appendChild(txt); list.appendChild(empty);
        }

        function getSortedReminders(list) {
            return [...list].sort((a,b)=>{
                if ((a.important?1:0) !== (b.important?1:0)) return (b.important?1:0) - (a.important?1:0);
                if (a.date && b.date){ 
                    const da=new Date(a.date), db=new Date(b.date); 
                    if(!isNaN(da.getTime()) && !isNaN(db.getTime())) return da - db; 
                }
                return 0;
            });
        }
        
        function renderReminders(){
            const list = $id('reminderList'); if (!list) return;
            list.innerHTML = '';

            const filtered = filterReminders(reminders);
            if (!filtered.length){ renderEmptyState(); return; }

            const sorted = getSortedReminders(filtered);

            sorted.forEach(reminder=>{
                if (!reminder) return;
                const dday = calculateDday(reminder.date);
                const isUrgent = dday && (dday.type === 'today' || (dday.type === 'future' && dday.diff <= 3));

                const item = document.createElement('div');
                item.className = 'reminder-item' + (reminder.children?.length? ' has-children' : '') + (isUrgent? ' urgent-alert' : '');
                
                const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                item.draggable = !isTouch;
                item.dataset.id = reminder.id;

                // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ìˆ˜ì •ëœ D&D ë¡œì§ ì‚¬ìš©)
                item.addEventListener('dragstart', function(e){ 
                    if (!this.dataset.id) return; 
                    draggedItem = this; 
                    this.classList.add('dragging'); 
                    try{ e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', this.dataset.id); }catch(_){}});
                
                item.addEventListener('dragend', function(){ 
                    if(this) this.classList.remove('dragging'); 
                    document.querySelectorAll('.reminder-item').forEach(i=>i.classList.remove('drag-over')); 
                    draggedItem = null; 
                });
                
                item.addEventListener('dragover', function(e){ 
                    if (e.preventDefault) e.preventDefault(); 
                    if (this !== draggedItem) this.classList.add('drag-over'); 
                    e.dataTransfer && (e.dataTransfer.dropEffect='move'); return false; 
                });
                
                item.addEventListener('drop', function(e){ 
                    if (e.stopPropagation) e.stopPropagation(); 
                    if (!draggedItem || !this.dataset.id) return false; 
                    if (draggedItem === this) return false; 
                    
                    const draggedId = draggedItem.dataset.id; 
                    const droppedId = this.dataset.id; 
                    
                    // 1. í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ (í•„í„°ë§/ì •ë ¬ëœ) ëª©ë¡ì˜ ID ìˆœì„œë¥¼ ê°€ì ¸ì˜´
                    const currentOrderIds = sorted.map(r => r.id);
                    const draggedIndexFiltered = currentOrderIds.indexOf(draggedId);
                    const droppedIndexFiltered = currentOrderIds.indexOf(droppedId);
                    
                    // 2. ì „ì²´ reminders ë°°ì—´ì—ì„œ í•­ëª©ì„ ì°¾ê³  ì œê±°
                    const draggedIndexUnfiltered = reminders.findIndex(r => r.id === draggedId);
                    if (draggedIndexUnfiltered === -1) return false;

                    const [removed] = reminders.splice(draggedIndexUnfiltered, 1);
                    
                    // 3. í•„í„°ë§ëœ ëª©ë¡ì—ì„œ ë“œë¡­ëœ í•­ëª© IDì˜ ìˆœìœ„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ì „ì²´ ë°°ì—´ì—ì„œ ì‚½ì…í•  ìœ„ì¹˜ë¥¼ ì°¾ìŒ
                    
                    // í•„í„°ë§ë˜ì§€ ì•Šì€ ë°°ì—´ì—ì„œ ë“œë¡­ëœ í•­ëª©ì˜ ì¸ë±ìŠ¤
                    const targetReminderIndex = reminders.findIndex(r => r.id === droppedId); 
                    
                    let insertIndex = targetReminderIndex;

                    // dropped itemì´ filtered listì—ì„œ dragged itemë³´ë‹¤ ë’¤ì— ìˆì—ˆë‹¤ë©´, ì¸ë±ìŠ¤ë¥¼ +1 í•´ì¤Œ
                    // (spliceëŠ” í˜„ì¬ ì¸ë±ìŠ¤ì— ì‚½ì…í•˜ë¯€ë¡œ, ë’¤ë¡œ ì´ë™í•˜ëŠ” ê²½ìš° ì¸ë±ìŠ¤ë¥¼ í•˜ë‚˜ ëŠ˜ë ¤ì•¼ í•¨)
                    if (draggedIndexFiltered < droppedIndexFiltered) {
                        insertIndex = targetReminderIndex + 1;
                    } 
                    
                    if (insertIndex === -1) {
                         // ì‚½ì… ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ë°°ì—´ì˜ ëì— ì¶”ê°€ (ì•ˆì „ ì¥ì¹˜)
                        reminders.push(removed); 
                    } else {
                        reminders.splice(insertIndex, 0, removed);
                    }
                    
                    saveToStorage(); 
                    renderReminders(); 
                    return false; 
                });
                
                item.addEventListener('dragleave', function(){ this.classList.remove('drag-over'); });

                // ë³„
                const starBtn = document.createElement('div'); starBtn.className='star-btn'; starBtn.appendChild(createStarIcon(!!reminder.important));
                starBtn.addEventListener('click', function(e){ e.stopPropagation(); toggleImportant(reminder.id); });
                item.appendChild(starBtn);

                // í† ê¸€ (í”„ë¡œì íŠ¸)
                if (reminder.children?.length){
                    const toggleBtn = document.createElement('div'); toggleBtn.className = 'toggle-btn' + (reminder.collapsed? ' collapsed' : ''); toggleBtn.textContent = 'â–¼'; 
                    toggleBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleChildren(reminder.id); });
                    item.appendChild(toggleBtn);
                }

                const content = document.createElement('div'); content.className = 'reminder-content';
                const textDiv = createTextDiv('reminder-text', reminder.text || '');
                content.appendChild(textDiv);
                item.appendChild(content);

                if (dday){ const ddayEl = createTextDiv('reminder-dday ' + dday.type, dday.text); item.appendChild(ddayEl); }

                const deleteBtn = document.createElement('div'); deleteBtn.className='delete-btn'; deleteBtn.textContent='Ã—'; deleteBtn.addEventListener('click', function(e){ e.stopPropagation(); deleteReminder(reminder.id); });
                item.appendChild(deleteBtn);

                item.addEventListener('click', function(){ editReminder(reminder.id); });

                list.appendChild(item);

                // í•˜ìœ„ í•­ëª© ë Œë”
                if (reminder.children?.length){
                    const childContainer = document.createElement('div'); childContainer.className = 'child-items';
                    if (!reminder.collapsed) childContainer.classList.add('expanded');

                    reminder.children.forEach((child, idx)=>{
                        const childItem = document.createElement('div'); childItem.className = 'child-item' + (child.completed? ' completed' : '');
                        const checkbox = document.createElement('input'); checkbox.type='checkbox'; checkbox.className='child-checkbox'; checkbox.checked = !!child.completed;
                        checkbox.addEventListener('click', function(e){ e.stopPropagation(); toggleChildComplete(reminder.id, idx); });
                        const text = document.createElement('span'); text.className='child-text'; text.appendChild(document.createTextNode(child.text || ''));
                        childItem.appendChild(checkbox); childItem.appendChild(text); childContainer.appendChild(childItem);
                    });

                    list.appendChild(childContainer);
                }
            });
        }

        function toggleChildren(id){ const r = reminders.find(rr=>rr && rr.id===id); if (r){ r.collapsed = !r.collapsed; saveToStorage(); renderReminders(); } }
        function toggleChildComplete(reminderId, childIndex){ const r = reminders.find(rr=>rr && rr.id===reminderId); if (r && Array.isArray(r.children) && r.children[childIndex]){ r.children[childIndex].completed = !r.children[childIndex].completed; saveToStorage(); renderReminders(); } }
        function toggleImportant(id){ const r = reminders.find(rr=>rr && rr.id===id); if (r){ r.important = !r.important; saveToStorage(); renderReminders(); } }
        function deleteReminder(id){ reminders = reminders.filter(r=>r && r.id!==id); saveToStorage(); renderReminders(); }

        // í¸ì§‘/ì¶”ê°€ (ìˆ˜ì •ë¨: tempChildrenì— completed ìƒíƒœê¹Œì§€ ë³µì‚¬)
        function editReminder(id){ 
            const reminder = reminders.find(r=>r && r.id===id); 
            if (!reminder) return; 
            
            editingId = id; 
            // **ìˆ˜ì •ëœ ë¶€ë¶„: í•˜ìœ„ í•­ëª© ê°ì²´ ì „ì²´ë¥¼ ë³µì‚¬**
            tempChildren = Array.isArray(reminder.children)? reminder.children.map(c=>({...c})) : []; 
            
            const modalTitle = $id('modalTitle'); 
            const reminderText = $id('reminderText'); 
            const reminderDate = $id('reminderDate'); 
            const isImportant = $id('isImportant'); 
            const hasChildren = $id('hasChildren'); 
            const childList = $id('childList'); 
            const reminderModal = $id('reminderModal'); 
            
            if (modalTitle) modalTitle.textContent='ë¦¬ë§ˆì¸ë” ìˆ˜ì •'; 
            if (reminderText) reminderText.value = reminder.text || ''; 
            if (reminderDate) reminderDate.value = reminder.date || ''; 
            if (isImportant) isImportant.checked = !!reminder.important; 
            if (hasChildren) hasChildren.checked = reminder.children?.length>0; 
            
            if (childList && reminder.children?.length>0){ 
                childList.style.display='block'; 
                renderTempChildren(); 
            } else if (childList) {
                childList.style.display='none';
                renderTempChildren(); // í•˜ìœ„ í•­ëª©ì´ ì—†ìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ ë¹„ìš°ê¸°
            }
            
            if (reminderModal) reminderModal.classList.add('active'); 
            if (reminderText){ requestAnimationFrame(()=>{ try{ reminderText.focus(); }catch(_){} }); }
        }

        // ì„ì‹œ í•˜ìœ„ í•­ëª© ë Œë”ë§ (ìˆ˜ì •ë¨: completed ìƒíƒœ í‘œì‹œ ì¶”ê°€)
        function renderTempChildren(){ 
            const container = $id('childItems'); 
            if (!container) return; 
            
            container.innerHTML=''; 
            
            tempChildren.forEach((child, index)=>{ 
                const item = document.createElement('div'); 
                item.style.cssText='display:flex;gap:6px;margin-bottom:6px;align-items:center'; 
                
                const span = document.createElement('span'); 
                span.style.flex='1'; span.style.fontSize='12px'; span.style.color='#666'; 
                
                // ì™„ë£Œ ìƒíƒœë¥¼ í‘œì‹œí•˜ëŠ” ìŠ¤íƒ€ì¼ ì¶”ê°€
                if (child.completed) {
                    span.style.textDecoration = 'line-through';
                    span.style.opacity = '0.6';
                }
                
                span.textContent = 'â€¢ ' + (child.text || ''); 
                
                const btn = document.createElement('span'); 
                btn.style.fontSize='18px'; btn.style.color='#ddd'; btn.style.cursor='pointer'; btn.textContent = 'Ã—'; 
                btn.addEventListener('mouseover', ()=>btn.style.color='#ff6b9d'); 
                btn.addEventListener('mouseout', ()=>btn.style.color='#ddd'); 
                btn.addEventListener('click', ()=>{ removeTempChild(index); }); 
                
                item.appendChild(span); item.appendChild(btn); container.appendChild(item); 
            }); 
        }

        function removeTempChild(index){ if (index>=0 && index<tempChildren.length){ tempChildren.splice(index,1); renderTempChildren(); } }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©: í•„í„° ë²„íŠ¼
        document.querySelectorAll('.filter-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ document.querySelectorAll('.filter-btn').forEach(b=>{ b.classList.remove('active'); b.style.background = currentTheme.accent; b.style.color = currentTheme.icon; }); btn.classList.add('active'); btn.style.background = currentTheme.icon; btn.style.color = 'white'; currentFilter = btn.dataset.filter || 'all'; renderReminders(); }); });

        const addBtn = $id('addBtn'); if (addBtn) addBtn.addEventListener('click', openAddModal);

        function openAddModal(){ 
            editingId = null; 
            tempChildren = []; // ë¹ˆ ê°ì²´ ë°°ì—´ë¡œ ì´ˆê¸°í™” 
            const modalTitle = $id('modalTitle'); const reminderText = $id('reminderText'); const reminderDate = $id('reminderDate'); const isImportant = $id('isImportant'); const hasChildren = $id('hasChildren'); const childList = $id('childList'); const reminderModal = $id('reminderModal'); 
            if (modalTitle) modalTitle.textContent='ë¦¬ë§ˆì¸ë” ì¶”ê°€'; if (reminderText) reminderText.value=''; if (reminderDate) reminderDate.value=''; if (isImportant) isImportant.checked=false; if (hasChildren) hasChildren.checked=false; if (childList) childList.style.display='none'; 
            if (reminderModal) reminderModal.classList.add('active'); 
            renderTempChildren(); // ì„ì‹œ í•˜ìœ„ í•­ëª© ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

            if (reminderText) requestAnimationFrame(()=>{ try{ reminderText.focus(); }catch(_){} }); 
        }

        const hasChildrenEl = $id('hasChildren'); if (hasChildrenEl) hasChildrenEl.addEventListener('change', (e)=>{ const childList = $id('childList'); if (childList) childList.style.display = e.target.checked ? 'block' : 'none'; });

        const addChildBtn = $id('addChildBtn'); const childInput = $id('childInput'); 
        if (addChildBtn) addChildBtn.addEventListener('click', addChildItem); 
        if (childInput) childInput.addEventListener('keypress', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); addChildItem(); } });
        
        // í•˜ìœ„ í•­ëª© ì¶”ê°€ (ìˆ˜ì •ë¨: ê°ì²´ í˜•íƒœë¡œ ì €ì¥)
        function addChildItem(){ 
            const input = $id('childInput'); 
            if (input && input.value.trim()){ 
                tempChildren.push({ text: input.value.trim(), completed: false }); // ê°ì²´ í˜•íƒœë¡œ ì €ì¥
                input.value=''; 
                renderTempChildren(); 
            } 
        }

        const saveBtn = $id('saveBtn'); if (saveBtn) saveBtn.addEventListener('click', saveReminder);
        const reminderTextInput = $id('reminderText'); if (reminderTextInput) reminderTextInput.addEventListener('keypress', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); saveReminder(); } });

        // ë¦¬ë§ˆì¸ë” ì €ì¥ (ìˆ˜ì •ë¨: tempChildrenì´ ê°ì²´ ë°°ì—´ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ childrenì— í• ë‹¹)
        function saveReminder(){ 
            const reminderText = $id('reminderText'); 
            const reminderDate = $id('reminderDate'); 
            const isImportant = $id('isImportant'); 
            const hasChildrenCheckbox = $id('hasChildren'); 
            const reminderModal = $id('reminderModal'); 
            
            if (!reminderText) return; 
            
            const text = reminderText.value.trim(); 
            if (!text){ alert('í•  ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); reminderText.focus(); return; }
            
            const newReminder = {
                id: editingId || generateId(),
                text: text,
                date: reminderDate ? reminderDate.value : '',
                important: isImportant ? isImportant.checked : false,
                // **ìˆ˜ì •ëœ ë¶€ë¶„: tempChildrenì´ ì´ë¯¸ ê°ì²´ ë°°ì—´ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©**
                children: (hasChildrenCheckbox && hasChildrenCheckbox.checked) ? tempChildren : [], 
                collapsed: false
            };
            
            if (editingId){ 
                const index = reminders.findIndex(r=>r && r.id===editingId); 
                if (index !== -1){ 
                    const oldCollapsed = reminders[index].collapsed; 
                    newReminder.collapsed = oldCollapsed; 
                    reminders[index] = newReminder; 
                } 
            }else{ 
                reminders.unshift(newReminder); // ì‹ ê·œëŠ” ë§¨ ì•ì— ì¶”ê°€
            }
            
            saveToStorage(); 
            if (reminderModal) reminderModal.classList.remove('active'); 
            renderReminders(); 
        }

        const cancelBtn = $id('cancelBtn'); if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
        function closeModal(){ const reminderModal = $id('reminderModal'); if (reminderModal) reminderModal.classList.remove('active'); }

        // ESCë¡œ ë‹«ê¸°
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape'){ const reminderModal = $id('reminderModal'); const colorModal = $id('colorModal'); if (reminderModal && reminderModal.classList.contains('active')) reminderModal.classList.remove('active'); if (colorModal && colorModal.classList.contains('active')) colorModal.classList.remove('active'); } });

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ë‹«ê¸°
        const reminderModal = $id('reminderModal'); const colorModal = $id('colorModal'); 
        if (reminderModal) reminderModal.addEventListener('click', (e)=>{ if (e.target === reminderModal) reminderModal.classList.remove('active'); }); 
        if (colorModal) colorModal.addEventListener('click', (e)=>{ if (e.target === colorModal) colorModal.classList.remove('active'); });

        const colorBtn = $id('colorBtn'); if (colorBtn) colorBtn.addEventListener('click', ()=>{ const colorModal = $id('colorModal'); if (colorModal) colorModal.classList.add('active'); });
        const closeColorBtn = $id('closeColorBtn'); if (closeColorBtn) closeColorBtn.addEventListener('click', ()=>{ const colorModal = $id('colorModal'); if (colorModal) colorModal.classList.remove('active'); });

        // ì´ˆê¸°í™”
        loadFromStorage(); 
        applyTheme(currentTheme);
        renderReminders();

        // SVG ìƒì„± (ìŠ¤íƒ€ ì•„ì´ì½˜)
        function createStarIcon(isFilled){
            const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
            svg.setAttribute('viewBox','0 0 24 24');
            svg.setAttribute('width','16'); svg.setAttribute('height','16');
            svg.setAttribute('fill', isFilled ? currentTheme.icon : 'none');
            svg.setAttribute('stroke', currentTheme.icon);
            svg.setAttribute('stroke-width','2'); svg.setAttribute('stroke-linecap','round'); svg.setAttribute('stroke-linejoin','round');
            const path = document.createElementNS('http://www.w3.org/2000/svg','path');
            path.setAttribute('d','M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z');
            svg.appendChild(path); return svg;
        }
    })();
    </script>
</body>
</html>
